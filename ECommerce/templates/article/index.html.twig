{% extends 'base.html.twig' %}

{% block title %}Article index{% endblock %}

{% block body %}

    <link href="{{ asset('css/All-Article.css') }}" rel="stylesheet"/>


    <div class="articleWithFilter">
        <div class="filter" id="myBtnContainer">

            <div class="select-box">
                <div class="select-box__current" tabindex="1">
                    <div class="select-box__value">
                        <input class="select-box__input" type="radio" id="0" value="1" name="Ben" checked="checked"/>
                        <p class="select-box__input-text">Cream</p>
                    </div>
                    <div class="select-box__value">
                        <input class="select-box__input" type="radio" id="1" value="2" name="Ben" checked="checked"/>
                        <p class="select-box__input-text">Cheese</p>
                    </div>
                    <div class="select-box__value">
                        <input class="select-box__input" type="radio" id="2" value="3" name="Ben" checked="checked"/>
                        <p class="select-box__input-text">Milk</p>
                    </div>
                    <div class="select-box__value">
                        <input class="select-box__input" type="radio" id="3" value="4" name="Ben" checked="checked"/>
                        <p class="select-box__input-text">Honey</p>
                    </div>
                    <div class="select-box__value">
                        <input class="select-box__input" type="radio" id="4" value="5" name="Ben" checked="checked"/>
                        <p class="select-box__input-text">Cat√©gorie</p>
                    </div>
                    <img class="select-box__icon" src="http://cdn.onlinewebfonts.com/svg/img_295694.svg"
                         alt="Arrow Icon" aria-hidden="true"/>
                </div>
                <ul class="select-box__list">
                    <li>
                        <label class="select-box__option" for="0" aria-hidden="aria-hidden">Cream</label>
                    </li>
                    <li>
                        <label class="select-box__option" for="1" aria-hidden="aria-hidden">Cheese</label>
                    </li>
                    <li>
                        <label class="select-box__option" for="2" aria-hidden="aria-hidden">Milk</label>
                    </li>
                    <li>
                        <label class="select-box__option" for="3" aria-hidden="aria-hidden">Honey</label>
                    </li>
                    <li>
                        <label class="select-box__option" for="4" aria-hidden="aria-hidden">Toast</label>
                    </li>
                </ul>
            </div>

            <select class="custom-dropdown" id="select">
                <option></option>
            </select>
            <button class="btn" onclick="filter()"> Show all</button>
            <button class="btn" onclick="checkNew()"> Nouveaux</button>
            <button class="btn" onclick="onlyPromo()"> En promotion</button>
            <button class="btn" onclick="onlyStock()"> En stock</button>
            <div style="z-index: 0;">
                <p id="price">1</p>
                <input type="range" min="1" max="1000" value="1" class="slider" id="myRange"
                       onchange="minFilter($(this).val())">
            </div>
        </div>

        <div class="all-article">

        </div>
    </div>
    <div class="admin-a">
        <a href="{{ path('article_new') }}">Create new</a>
    </div>


    <script>

        var articles = [];

        var yesStock = "{{ asset('icon/yes-stock.png') }} }}";
        var noStock = "{{ asset('icon/no-stock.png') }} }}";

        var isNew = false;
        var isPromo = false;
        var isStock = false;

        var category = "";

        var showAll = true;
        var min = 0;

        function checkNew() {
            isNew = !isNew;
            showAll = false;
            showArticles();
        }

        function onlyPromo() {
            showAll = false;
            isPromo = !isPromo;
            showArticles();
        }

        function onlyStock() {
            showAll = false;
            isStock = !isStock;
            showArticles();
        }

        function minFilter(prix) {
            min = prix;
            $('#price').html(prix);
            showArticles();
        }



        {% for article in articles %}
        var newArticle = [];
        newArticle['isNew'] = "{{ article.isNew ? 'New' : null }}";
        newArticle['nom'] = "{{ article.nom }}";
        newArticle['caracteristiques'] = "{{ article.caracteristiques |truncate(30, true) }}";
        newArticle['prixUnitaire'] = "{{ article.prixUnitaire }}";
        {% if article.qteEnStock > 0 %}
        newArticle['isqteEnStock'] = "<img src=\"{{ asset('icon/yes-stock.png') }}\" class=\"stock\">"
        {% else %}
        newArticle['isqteEnStock'] = "<img src=\"{{ asset('icon/no-stock.png') }}\" class=\"stock\">";
        {% endif %}
        newArticle['qteEnStock'] = "{{ article.qteEnStock }}";
        newArticle['promotion'] = "{{ article.promotion }}";
        newArticle['categorie'] = "{{ article.categorie }}";
        {% if article.promotion > 0 %}
        newArticle['ispromotion'] = "-{{ article.promotion }}";
        {% else %}
        newArticle['ispromotion'] = "";
        {% endif %}

        newArticle['id'] = "{{ article.id }}";
        {% for image in article.images %}
        {% if loop.first %}
        newArticle['image'] = "{{ image.lien }}";
        {% endif %}
        {% endfor %}


        articles.push(newArticle);
        {% endfor %}


        $.ajax({
            type: "GET",
            url: '/article/api/getCategories',
            success: function (data) {
                data.forEach(element => {
                    $('#select').append('<option>' + element + '</option>')
                });
            }
        });

        $('#select').change(function () {
            category = $(this).val();
            showArticles();
        });

        function filter() {
            showAll = true;
            articles = [];
            $.ajax({
                type: "GET",
                url: '/article/api/getAllArticles',
                success: function (data) {

                    data.forEach(element => {
                        var newArticle = [];
                        if (element.is_new) {
                            newArticle['isNew'] = 'New';
                        } else {
                            newArticle['isNew'] = '';
                        }
                        newArticle['nom'] = "" + element.nom;
                        newArticle['caracteristiques'] = "" + element.caracteristiques;
                        newArticle['prixUnitaire'] = "" + element.prix_unitaire;
                        newArticle['categorie'] = "" + element.categorie;
                        if (element.qte_en_stock > 0) {
                            newArticle['isqteEnStock'] = "<img src=\"{{ asset('icon/yes-stock.png') }}\" class=\"stock\">"
                        } else {
                            newArticle['isqteEnStock'] = "<img src=\"{{ asset('icon/no-stock.png') }}\" class=\"stock\">";
                        }
                        newArticle['qteEnStock'] = "" + element.qte_en_stock;
                        newArticle['promotion'] = "" + element.promotion;
                        if (element.promotion > 0) {
                            newArticle['ispromotion'] = "-" + element.promotion;
                        } else {
                            newArticle['ispromotion'] = "";
                        }
                        newArticle['id'] = element.id;
                        newArticle['image'] = element.image;
                        articles.push(newArticle);
                    });
                    showArticles();

                    console.log(data);
                }
            });

            showArticles();
        }

        function showArticles() {
            $('.all-article').html('');
            articles.forEach(element => {
                console.log(element.prixUnitaire);
                if (min >= parseInt(element.prixUnitaire)) {
                    return;
                }
                if (category !== "") {
                    if (category !== element.categorie) {
                        return;
                    }
                }
                if (showAll === false) {
                    if (((isNew === true && element.isNew === '') || (isNew === false && element.isNew === 'New')) || ((isPromo === true && element.promotion <= 0) || (isPromo === false && element.promotion > 0))
                        || ((isStock === true && element.isqteEnStock === "<img src=\"{{ asset('icon/no-stock.png') }}\" class=\"stock\">") || (isStock === false && element.isqteEnStock === "<img src=\"{{ asset('icon/yes-stock.png') }}\" class=\"stock\">"))
                    ) {
                        return;
                    }
                }
                $('.all-article').append(
                    '<div class="article">\n' +
                    '<p class="new">' + element.isNew + '</p>\n' +
                    '                        <img class="img-10" src="' + element.image + '">\n' +
                    '                <div class="nom-description">\n' +
                    '                    <p class="text">' + element.nom + '</p>\n' +
                    '                    <p class="crop">' + element.caracteristiques + '</p>\n' +
                    '                </div>\n' +
                    '                <div class="stock-price">\n' +
                    '                    <p class="prix">' + element.prixUnitaire + '&#8364</p>\n' +
                    '<p class="stock-texte">' + element.isqteEnStock + ' En stock</p>' +

                    '                </div>\n' +
                    '                <p class="text-promotion">\n' + element.ispromotion + '</p>\n' +
                    '                <div class="show-edit">\n' +
                    '                    <a href="/article/' + element.id + '">show</a>\n' +
                    '                    <a href="/article/' + element.id + '/edit">Edit</a>\n'
                );
            })
        }

        showArticles();

        function readMore() {
            var dots = document.getElementById("dots");
            var moreText = document.getElementById("more");
            var btnText = document.getElementById("myBtn");

            if (dots.style.display === "none") {
                dots.style.display = "inline";
                btnText.innerHTML = "Read more";
                moreText.style.display = "none";
            } else {
                dots.style.display = "none";
                btnText.innerHTML = "Read less";
                moreText.style.display = "inline";
            }
        }

        $('#myRange').on("change mousemove", function () {
            $('#price').html($(this).val());
        });
    </script>
{% endblock %}
